<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Richiesta Sopralluogo - Condominio</title>
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#1e3c72">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
      padding: 16px;
      color: #333;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    header {
      text-align: center;
      padding: 24px 16px;
      background: linear-gradient(90deg, #1e3c72, #2a5298);
      color: white;
      border-radius: 16px;
      margin-bottom: 24px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    h1 {
      font-size: 1.8rem;
      font-weight: 700;
      margin-bottom: 8px;
    }
    .subtitle {
      opacity: 0.9;
      font-size: 1.1rem;
    }
    .grid {
      display: grid;
      gap: 24px;
      grid-template-columns: 1fr;
    }
    @media (min-width: 768px) {
      .grid { grid-template-columns: 1fr 1fr; }
    }
    .card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.08);
      padding: 24px;
    }
    .card-title {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
      font-size: 1.4rem;
      font-weight: 600;
      color: #2c3e50;
    }
    .card-title svg { width: 24px; height: 24px; }
    .form-group {
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #2c3e50;
    }
    .required::after {
      content: " *";
      color: #e74c3c;
    }
    input, textarea, select {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    input:focus, textarea:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    }
    textarea { min-height: 100px; resize: vertical; }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      width: 100%;
      background: linear-gradient(90deg, #27ae60, #2ecc71);
      color: white;
      border: none;
      padding: 16px;
      font-size: 1.1rem;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.2s, opacity 0.2s;
    }
    .btn:hover:not(:disabled) {
      transform: translateY(-2px);
      opacity: 0.95;
    }
    .btn:disabled {
      background: #95a5a6;
      cursor: not-allowed;
    }
    .notice {
      background: #e3f2fd;
      border-left: 4px solid #2196f3;
      padding: 16px;
      border-radius: 0 8px 8px 0;
      font-size: 0.95rem;
      margin-top: 20px;
    }
    .notice strong { color: #0d47a1; }
    .interventi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }
    .intervento-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .intervento-item:hover { background: #e9ecef; }
    .intervento-item.selected { background: #d4edda; border: 1px solid #28a745; }
    .tariffario-list {
      list-style: none;
    }
    .tariffario-item {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid #eee;
    }
    .tariffario-price {
      background: linear-gradient(90deg, #3498db, #2980b9);
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-weight: bold;
      min-width: 80px;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üîß Richiesta di Sopralluogo</h1>
      <p class="subtitle">Compila il modulo per generare e scaricare un documento PDF con la tua richiesta</p>
    </header>

    <div class="grid">
      <!-- Tariffario -->
      <div class="card">
        <div class="card-title">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" stroke-width="2"/>
          </svg>
          Tariffario Orario (Indicativo)
        </div>
        <ul class="tariffario-list">
          <li class="tariffario-item">
            <span>Manutenzione idraulica</span>
            <span class="tariffario-price">‚Ç¨35,00/h</span>
          </li>
          <li class="tariffario-item">
            <span>Manutenzione elettrica</span>
            <span class="tariffario-price">‚Ç¨40,00/h</span>
          </li>
          <li class="tariffario-item">
            <span>Riparazioni murarie</span>
            <span class="tariffario-price">‚Ç¨30,00/h</span>
          </li>
          <li class="tariffario-item">
            <span>Pulizia e sanificazione</span>
            <span class="tariffario-price">‚Ç¨25,00/h</span>
          </li>
          <li class="tariffario-item">
            <span>Manutenzione ascensori</span>
            <span class="tariffario-price">‚Ç¨50,00/h</span>
          </li>
          <li class="tariffario-item">
            <span>Giardinaggio condominiale</span>
            <span class="tariffario-price">‚Ç¨28,00/h</span>
          </li>
          <li class="tariffario-item">
            <span>Sostituzione infissi</span>
            <span class="tariffario-price">‚Ç¨45,00/h</span>
          </li>
          <li class="tariffario-item">
            <span>Assistenza caldaie</span>
            <span class="tariffario-price">‚Ç¨42,00/h</span>
          </li>
        </ul>
        <div class="notice">
          <strong>Nota:</strong> I prezzi indicati sono puramente indicativi e non saranno inclusi nel PDF.
        </div>
      </div>

      <!-- Form -->
      <div class="card">
        <div class="card-title">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" stroke-width="2"/>
            <polyline points="14 2 14 8 20 8" stroke-width="2"/>
            <line x1="16" y1="13" x2="8" y2="13" stroke-width="2"/>
            <line x1="16" y1="17" x2="8" y2="17" stroke-width="2"/>
            <polyline points="10 9 9 9 8 9" stroke-width="2"/>
          </svg>
          Richiesta Sopralluogo
        </div>

        <form id="sopralluogoForm">
          <div class="form-group">
            <label class="required">Via</label>
            <input type="text" id="via" placeholder="Via Roma" required>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div class="form-group">
              <label class="required">Numero Civico</label>
              <input type="text" id="civico" placeholder="12" required>
            </div>
            <div class="form-group">
              <label class="required">CAP</label>
              <input type="text" id="cap" placeholder="00100" required pattern="\d{5}" title="CAP: 5 cifre">
            </div>
          </div>

          <div class="form-group">
            <label class="required">Citt√†</label>
            <input type="text" id="citta" placeholder="Roma" required>
          </div>

          <div class="form-group">
            <label class="required">Nome Referente</label>
            <input type="text" id="nomeReferente" placeholder="Mario Rossi" required>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div class="form-group">
              <label>Email</label>
              <input type="email" id="emailReferente" placeholder="mario@email.com">
            </div>
            <div class="form-group">
              <label>Telefono</label>
              <input type="tel" id="telefonoReferente" placeholder="333 123 4567">
            </div>
          </div>

          <div class="form-group">
            <label class="required">Intervento richiesto</label>
            <textarea id="descrizioneIntervento" placeholder="Descrivi brevemente il tipo di intervento richiesto..." required></textarea>
          </div>

          <!-- ‚úÖ CAMPO SEGNALATORE DOPO INTERVENTO RICHIESTO -->
          <div class="form-group">
            <label>Segnalatore</label>
            <input type="text" id="segnalatore" placeholder="Es. Amministratore, ditta, cliente privato">
          </div>

          <div class="form-group">
            <label>Tipo di intervento (facoltativo)</label>
            <div class="interventi-grid" id="interventiContainer"></div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div class="form-group">
              <label>Data Sopralluogo</label>
              <input type="date" id="dataSopralluogo">
            </div>
            <div class="form-group">
              <label>Orario Sopralluogo</label>
              <input type="time" id="orarioSopralluogo">
            </div>
          </div>

          <button type="submit" id="generateBtn" class="btn">
            <span id="btnText">‚úÖ Genera e Scarica PDF</span>
          </button>

          <div class="notice">
            <strong>Nota:</strong> I campi con * sono obbligatori. Il PDF verr√† scaricato automaticamente.
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    // ‚úÖ Service Worker (PWA)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js')
          .catch(err => console.warn('SW non registrato:', err));
      });
    }

    // Inizializza jsPDF
    const { jsPDF } = window.jspdf;

    // Interventi
    const interventiOptions = [
      'Manutenzione idraulica',
      'Manutenzione elettrica',
      'Riparazioni murarie',
      'Pulizia e sanificazione',
      'Manutenzione ascensori',
      'Giardinaggio condominiale',
      'Sostituzione infissi',
      'Assistenza caldaie'
    ];
    let selectedInterventi = [];

    // Render checkbox
    const container = document.getElementById('interventiContainer');
    interventiOptions.forEach(intervento => {
      const div = document.createElement('div');
      div.className = 'intervento-item';
      div.innerHTML = `
        <input type="checkbox" id="chk_${intervento.replace(/\s+/g, '_')}" style="width:16px;height:16px;">
        <label for="chk_${intervento.replace(/\s+/g, '_')}">${intervento}</label>
      `;
      const checkbox = div.querySelector('input');
      checkbox.addEventListener('change', () => {
        if (checkbox.checked) {
          selectedInterventi.push(intervento);
        } else {
          selectedInterventi = selectedInterventi.filter(i => i !== intervento);
        }
        div.classList.toggle('selected', checkbox.checked);
      });
      container.appendChild(div);
    });

    // ‚úÖ Genera e SCARICA PDF AL PRIMO CLIC
    document.getElementById('sopralluogoForm').addEventListener('submit', function(e) {
      e.preventDefault();

      // Validazione obbligatori
      const requiredIds = ['via', 'civico', 'cap', 'citta', 'nomeReferente', 'descrizioneIntervento'];
      for (const id of requiredIds) {
        const el = document.getElementById(id);
        if (!el.value.trim()) {
          alert('‚ö†Ô∏è Compila tutti i campi obbligatori.');
          el.focus();
          return;
        }
      }

      // Validazione CAP
      const cap = document.getElementById('cap').value;
      if (cap && !/^\d{5}$/.test(cap)) {
        alert('‚ö†Ô∏è CAP non valido: inserisci 5 cifre.');
        document.getElementById('cap').focus();
        return;
      }

      // Validazione email
      const email = document.getElementById('emailReferente').value;
      if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        alert('‚ö†Ô∏è Email non valida.');
        document.getElementById('emailReferente').focus();
        return;
      }

      // Validazione telefono (opzionale ma controllato)
      const tel = document.getElementById('telefonoReferente').value;
      if (tel && !/^[\d\s\-\+()]{7,20}$/.test(tel)) {
        alert('‚ö†Ô∏è Telefono non valido.');
        document.getElementById('telefonoReferente').focus();
        return;
      }

      // Raccolta dati
      const data = {
        via: document.getElementById('via').value,
        civico: document.getElementById('civico').value,
        cap: document.getElementById('cap').value,
        citta: document.getElementById('citta').value,
        nomeReferente: document.getElementById('nomeReferente').value,
        email: email,
        telefono: tel,
        descrizioneIntervento: document.getElementById('descrizioneIntervento').value,
        segnalatore: document.getElementById('segnalatore').value.trim() || 'Non specificato',
        dataSopralluogo: document.getElementById('dataSopralluogo').value,
        orarioSopralluogo: document.getElementById('orarioSopralluogo').value,
        interventi: selectedInterventi
      };

      // Formattazione data
      const formatDate = (dateStr) => dateStr ? new Date(dateStr).toLocaleDateString('it-IT') : 'Non specificata';
      const formatTime = (timeStr) => timeStr || 'Non specificato';

      try {
        const doc = new jsPDF({
          orientation: 'portrait',
          unit: 'mm',
          format: 'a4'
        });

        // Intestazione
        doc.setFillColor(30, 60, 114);
        doc.rect(0, 0, 210, 40, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(18);
        doc.setFont('helvetica', 'bold');
        doc.text('RICHIESTA INTERVENTO MANUTENZIONE CONDOMINIALE', 105, 22, { align: 'center' });
        doc.setFontSize(11);
        doc.setFont('helvetica', 'normal');
        doc.text('Documento per richiesta di sopralluogo tecnico', 105, 30, { align: 'center' });

        let y = 50;
        const marginLeft = 20;

        const addSection = (title, lines) => {
          if (y > 260) { doc.addPage(); y = 20; }
          doc.setTextColor(30, 60, 114);
          doc.setFontSize(12);
          doc.setFont('helvetica', 'bold');
          doc.text(title, marginLeft, y);
          y += 10;
          doc.setDrawColor(200, 200, 200);
          doc.setLineWidth(0.5);
          doc.line(marginLeft, y, 210 - marginLeft, y);
          y += 8;
          doc.setTextColor(50, 50, 50);
          doc.setFontSize(11);
          doc.setFont('helvetica', 'normal');
          lines.forEach(line => {
            if (y > 260) { doc.addPage(); y = 20; }
            doc.text(line, marginLeft, y);
            y += 7;
          });
          y += 6;
        };

        // Sezioni PDF
        addSection('DATI CONDOMINIO', [
          `Via: ${data.via}`,
          `Numero Civico: ${data.civico}`,
          `CAP: ${data.cap}`,
          `Citt√†: ${data.citta}`
        ]);

        const contatti = [];
        if (data.email) contatti.push(`Email: ${data.email}`);
        if (data.telefono) contatti.push(`Tel: ${data.telefono}`);
        addSection('DATI REFERENTE', [
          `Nome: ${data.nomeReferente}`,
          ...contatti
        ]);

        addSection('SEGNALATORE', [
          data.segnalatore
        ]);

        // Intervento richiesto
        if (y > 260) { doc.addPage(); y = 20; }
        doc.setTextColor(30, 60, 114);
        doc.setFontSize(12);
        doc.setFont('helvetica', 'bold');
        doc.text('INTERVENTO RICHIESTO', marginLeft, y);
        y += 10;
        doc.setDrawColor(200, 200, 200);
        doc.line(marginLeft, y, 210 - marginLeft, y);
        y += 8;
        doc.setTextColor(50, 50, 50);
        doc.setFontSize(11);
        doc.text('Descrizione:', marginLeft, y);
        y += 7;

        const descLines = doc.splitTextToSize(data.descrizioneIntervento, 170);
        descLines.forEach(line => {
          if (y > 260) { doc.addPage(); y = 20; }
          doc.text(line, marginLeft, y);
          y += 7;
        });
        y += 5;

        const tipologie = data.interventi.length > 0 ? data.interventi.join(', ') : 'Nessuna';
        doc.text(`Tipologia(e): ${tipologie}`, marginLeft, y);
        y += 10;

        addSection('PREFERENZE SOPRALLUOGO', [
          `Data: ${formatDate(data.dataSopralluogo)}`,
          `Orario: ${formatTime(data.orarioSopralluogo)}`
        ]);

        // Footer
        const now = new Date().toLocaleString('it-IT', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
        doc.setTextColor(100, 100, 100);
        doc.setFontSize(10);
        doc.text(`Generato il: ${now}`, marginLeft, 287);

        // ‚úÖ SCARICA IMMEDIATAMENTE
        const pdfBlob = doc.output('blob');
        const fileName = `richiesta_sopralluogo_${new Date().getTime()}.pdf`;

        const link = document.createElement('a');
        link.href = URL.createObjectURL(pdfBlob);
        link.download = fileName;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        setTimeout(() => URL.revokeObjectURL(link.href), 100);

        // ‚úÖ MESSAGGIO DI CONFERMA
        alert('‚úÖ PDF generato e scaricato con successo!\nControlla la cartella "Download".');

      } catch (err) {
        console.error('Errore PDF:', err);
        alert(`‚ùå Errore durante la generazione del PDF:\n${err.message}`);
      }
    });
  </script>
</body>
</html>
